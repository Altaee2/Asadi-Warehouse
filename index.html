<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¯ÙŠ Ù„Ù„Ø¨ÙˆØ±Ø³Ù„ÙŠÙ† </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #0b0f1a; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .input-style { background: #1e293b; border: 1px solid #334155; padding: 12px; border-radius: 10px; width: 100%; color: white; outline: none; transition: all 0.3s; }
        .input-style:focus { border-color: #38bdf8; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }
        .loading-overlay { position: fixed; inset: 0; background: #0b1120; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .low-stock-pulse { border: 2px solid #ef4444 !important; animation: border-pulse 2s infinite; }
        @keyframes border-pulse { 0% { border-color: #ef4444; } 50% { border-color: transparent; } 100% { border-color: #ef4444; } }
        .modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-blue-400 font-bold tracking-widest">Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø£Ø³Ø¯ÙŠ</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center p-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-900 to-slate-950">
        <div class="glass-card p-8 rounded-3xl w-full max-w-md shadow-2xl border-t border-white/20">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg rotate-3">
                    <i class="fas fa-shield-halved text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                <p class="text-slate-400 mt-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØ±Ø³Ù„ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
            <div class="space-y-5">
                <input type="email" id="loginEmail" class="input-style" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <input type="password" id="loginPass" class="input-style" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-500/20">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
                <p id="loginError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="appContent" class="hidden min-h-screen">
        <nav class="glass-card sticky top-0 z-40 p-4 border-b border-white/10">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <i class="fas fa-cubes text-3xl text-blue-500"></i>
                    <div>
                        <h2 class="font-bold text-xl tracking-tight"> Ø§Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ø¨ÙˆØ±Ø³Ù„ÙŠÙ† Ø§Ù„Ø§Ø³Ø¯ÙŠ</h2>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                            <span class="text-[10px] text-emerald-400 uppercase font-bold tracking-wider">Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    
                    <button id="btnLogout" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 px-4 py-2 rounded-xl transition text-sm font-bold border border-red-500/20">
                        <i class="fas fa-power-off ml-2"></i> Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4 lg:p-8">
            <!-- Stats Dashboard -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="glass-card p-5 rounded-2xl">
                    <p class="text-slate-400 text-xs mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù„ÙˆØ§Ù†</p>
                    <h3 id="statTotalItems" class="text-3xl font-black text-blue-500">0</h3>
                </div>
                
                <div class="glass-card p-5 rounded-2xl border-r-4 border-amber-500">
                    <p class="text-slate-400 text-xs mb-1">Ù‡Ù†Ø¯ÙŠ / Ø¥ÙŠØ±Ø§Ù†ÙŠ</p>
                    <div class="flex gap-2 items-baseline">
                        <span id="statOrigin" class="text-xl font-bold">0 / 0</span>
                    </div>
                </div>
                <div class="glass-card p-5 rounded-2xl border-r-4 border-red-500">
                    <p class="text-slate-400 text-xs mb-1">ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†ÙØ§Ø° (â‰¤50)</p>
                    <h3 id="statLowStock" class="text-3xl font-black text-red-500">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Side Form -->
                <div class="lg:col-span-4">
                    <div class="glass-card p-6 rounded-3xl sticky top-28 shadow-xl">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-3 text-blue-400">
                            <i class="fas fa-plus-circle"></i> ØªÙˆØ±ÙŠØ¯ Ø¨Ø¶Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </h3>
                        <form id="productForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="pCode" class="input-style" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ†" required>
                                <select id="pOrigin" class="input-style">
                                    <option value="Ù‡Ù†Ø¯ÙŠ">Ù…Ù†Ø´Ø£ Ù‡Ù†Ø¯ÙŠ</option>
                                    <option value="Ø¥ÙŠØ±Ø§Ù†ÙŠ">Ù…Ù†Ø´Ø£ Ø¥ÙŠØ±Ø§Ù†ÙŠ</option>
                                </select>
                            </div>
                            <input type="text" id="pName" class="input-style" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ù„Ø§Ù‹: Ø¨ÙˆØ±Ø³Ù„ÙŠÙ† Ù„ÙŠØ²Ø± 60*120)" required>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="pQty" step="any" class="input-style" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹" required>
                                
                            </div>
                         

                              <div class="relative h-24 border-2 border-dashed border-slate-700 rounded-xl flex items-center justify-center bg-slate-800/20 cursor-pointer overflow-hidden">
                                <input type="file" id="pImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                                <div id="imagePreviewContainer" class="text-center">
                                    <i class="fas fa-camera text-2xl text-slate-500"></i>
                                    <p id="imageStatus" class="text-[10px] text-slate-400 mt-1">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</p>
                                </div>
                                <img id="previewImg" class="hidden absolute inset-0 w-full h-full object-cover">
                                </div>
                            <button type="submit" id="btnSave" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl transition-all shadow-lg">
                                <i class="fas fa-save ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†
                            </button>
                            
                        </form>
                    </div>
                </div>

                <!-- Product Grid -->
                <div class="lg:col-span-8">
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                            <input type="text" id="searchInput" class="input-style pr-12" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø£Ùˆ Ø§Ù„Ù…Ù†Ø´Ø£...">
                        <div class="relative flex-1">
</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="filterItems('Ø§Ù„ÙƒÙ„')" class="px-4 py-2 bg-slate-800 rounded-xl text-sm border border-white/5 active:bg-blue-600 transition">Ø§Ù„ÙƒÙ„</button>
                            <button onclick="filterItems('low')" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-xl text-sm border border-red-500/20 active:bg-red-600 transition">Ø§Ù„Ù†ÙˆØ§Ù‚Øµ</button>
                            <button onclick="exportToExcel()" class="px-4 py-2 bg-emerald-600/20 text-emerald-400 rounded-xl text-sm border border-emerald-500/20 active:bg-emerald-600 transition">
    <i class="fas fa-file-excel ml-1"></i> ØªØµØ¯ÙŠØ± Excel
</button>
<button onclick="exportToPDF()" class="px-4 py-2 bg-emerald-600/20 text-emerald-960 rounded-xl text-sm border border-emerald-500/20 active:bg-emerald-600 transition">
    <i class="fas fa-file-excel ml-1"></i> Ø·Ø¨Ø§Ø¹Ø©
</button>        
                   
                        </div>
                    </div>

                    <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Dynamic Cards -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="qtyModal" class="modal">
    <div class="glass-card p-8 rounded-3xl w-full max-w-sm border-t border-white/20">
        <h3 id="modalTitle" class="text-xl font-bold mb-4 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©</h3>
        <p id="modalItemName" class="text-slate-400 text-center text-sm mb-1"></p>
        <p id="modalCurrentQty" class="text-emerald-400 text-center text-xs mb-6 font-bold"></p> 
        
        <input type="number" id="modalInput" step="any" class="input-style mb-6 text-center text-2xl font-bold" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ù‡Ù†Ø§">
        <div class="grid grid-cols-2 gap-4">
            <button onclick="closeModal()" class="bg-slate-700 p-3 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="btnConfirmQty" class="bg-blue-600 p-3 rounded-xl font-bold">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>

    <div id="settingsModal" class="modal">
        <div class="glass-card p-8 rounded-3xl w-full max-w-md border-t border-white/20">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-bell text-yellow-500"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Telegram Bot Token</label>
                    <input type="text" id="tgToken" class="input-style text-xs" placeholder="Ø§Ø¯Ø®Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Telegram Chat ID</label>
                    <input type="text" id="tgChatId" class="input-style text-xs" placeholder="Ø§Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø§Øª">
                </div>
                <div class="p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <p class="text-[10px] text-blue-400 leading-relaxed">
                        * Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ØªÙ„Ø¬Ø±Ø§Ù… Ø¹Ù†Ø¯Ù…Ø§ ØªØµÙ„ Ø£ÙŠ Ù…Ø§Ø¯Ø© Ø¥Ù„Ù‰ ÙƒÙ…ÙŠØ© 50 Ø£Ùˆ Ø£Ù‚Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ù†Ø´Ø·.
                    </p>
                </div>
                
                <button onclick="saveSettings()" class="w-full bg-emerald-600 p-3 rounded-xl font-bold mt-4">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button onclick="closeModal()" class="w-full text-slate-500 text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
    
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAgGWk60BulYAgAAmM7xCxVc5zxURT-g5o",
            authDomain: "manage-asady.firebaseapp.com",
            projectId: "manage-asady",
            storageBucket: "manage-asady.firebasestorage.app",
            messagingSenderId: "80487794672",
            appId: "1:80487794672:web:cfdae9dfb6293e26de7f35"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "asady-porcelain-v2"; // Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙƒ

        let currentModalTarget = null;
        let currentModalAction = null;
        let settings = { tgToken: '', tgChatId: '' };
        let base64Image = ""; // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            if (user) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                await loadSettings();
                initInventoryListener();
            } else {
                document.getElementById('appContent').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
            }
        });

        // --- ØªØµØ­ÙŠØ­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© (ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù†Øµ Base64 ÙÙˆØ±Ø§Ù‹) ---
        document.getElementById('pImage').onchange = (e) => {
            const file = e.target.files[0];
            const statusText = document.getElementById('imageStatus');
            const previewImg = document.getElementById('previewImg');
            
            if (file) {
                statusText.innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: " + file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    base64Image = event.target.result; // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§
                    previewImg.src = base64Image;
                    previewImg.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                statusText.innerText = "Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©";
                previewImg.classList.add('hidden');
                base64Image = "";
            }
        };

        document.getElementById('btnLogin').onclick = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);

        // --- Settings & Telegram ---
        async function loadSettings() {
            try {
                const sDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'settings'));
                if (sDoc.exists()) {
                    settings = sDoc.data();
                    document.getElementById('tgToken').value = settings.tgToken || '';
                    document.getElementById('tgChatId').value = settings.tgChatId || '';
                }
            } catch (e) { console.error("Settings load fail", e); }
        }

        window.saveSettings = async () => {
            const tgToken = document.getElementById('tgToken').value;
            const tgChatId = document.getElementById('tgChatId').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'config', 'settings'), { tgToken, tgChatId });
            settings = { tgToken, tgChatId };
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…");
            closeModal();
        };

        async function sendTelegramAlert(itemName, qty, code) {
            if (!settings.tgToken || !settings.tgChatId) return;
            const message = `ğŸš¨ *ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø®Ø²Ù† Ø§Ù„Ø£Ø³Ø¯ÙŠ*\n\nØ§Ù„Ù…Ø§Ø¯Ø©: ${itemName}\nØ§Ù„ÙƒÙˆØ¯: ${code}\nØ§Ù„ÙƒÙ…ÙŠØ©: ${qty}\nâš ï¸ *Ø§Ù„ÙƒÙ…ÙŠØ© Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø°!*`;
            const url = `https://api.telegram.org/bot${settings.tgToken}/sendMessage?chat_id=${settings.tgChatId}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;
            try { fetch(url); } catch (e) { console.error("Telegram fail", e); }
        }

        // --- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ (ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ù„Ù‚ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±) ---
        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            // Ø§Ø¨Ø­Ø« Ø¹Ù† document.getElementById('productForm').onsubmit ÙˆØ­Ø¯Ø« Ø§Ù„Ù€ data
const data = {
    code: document.getElementById('pCode').value,
    name: document.getElementById('pName').value,
    qty: parseFloat(document.getElementById('pQty').value),
    origin: document.getElementById('pOrigin').value,
    image: base64Image || "https://via.placeholder.com/400x300",
    updatedAt: new Date().toISOString()
};

            try {
                // Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ³ (Firestore)
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), data);
                
                // ØªØµÙÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                e.target.reset();
                base64Image = "";
                document.getElementById('previewImg').classList.add('hidden');
                document.getElementById('imageStatus').innerText = "Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©";
                alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø®Ø²Ù† Ø¨Ù†Ø¬Ø§Ø­");
            } catch (err) {
                console.error(err);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø§Ù†ØªØ±Ù†Øª");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†';
            }
        };

        function initInventoryListener() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), orderBy('updatedAt', 'desc'));
            onSnapshot(q, (snap) => {
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '';
                let tItems = 0, tQty = 0, lowStock = 0, hindi = 0, irani = 0;

                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const id = docSnap.id;
                    tItems++; tQty += item.qty;
                    if (item.qty <= 50) lowStock++;
                    if (item.origin === 'Ù‡Ù†Ø¯ÙŠ') hindi++;
                    if (item.origin === 'Ø¥ÙŠØ±Ø§Ù†ÙŠ') irani++;

                    const isLow = item.qty <= 50;
                    const card = document.createElement('div');
                    card.className = `glass-card rounded-3xl overflow-hidden group border-2 ${isLow ? 'low-stock-pulse border-red-500/50 bg-red-500/5' : 'border-white/5'} transition-all duration-500`;
                    card.innerHTML = `
                        <div class="relative h-56 overflow-hidden">
                            <img src="${item.image}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                            <div class="absolute bottom-4 right-4 left-4 flex justify-between items-end">
                                <div>
                                    <span class="bg-blue-600 text-[15px] font-bold px-2 py-1 rounded-lg mb-1 inline-block uppercase tracking-wider">${item.origin}</span>
                                    <h4 class="font-bold text-white text-lg leading-tight truncate w-40">${item.name}</h4>
                                </div>
                                <div class="text-left">
                                    <span class="block text-[25px] text-slate-300">ÙƒÙˆØ¯: ${item.code}</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-5">
                            <div class="flex justify-between items-center mb-6 bg-white/5 p-3 rounded-2xl">
                                <span class="text-sm text-slate-400 font-medium">Ø§Ù„Ø§Ù…ØªØ§Ø± Ø§Ù„Ù…ØªÙˆÙØ±Ø©</span>
                                <div class="text-left">
                                    <span class="text-3xl font-black ${isLow ? 'text-red-500' : 'text-emerald-500'}">${item.qty}</span>
                                    <span class="text-[20px] text-slate-500 block">Ù…ØªØ± Ù…Ø±Ø¨Ø¹</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openQtyModal('${id}', '${item.name}', 'add', '${item.qty}')" class="bg-emerald-500/10 hover:bg-emerald-500 text-emerald-500 hover:text-white py-3 rounded-xl transition font-bold flex items-center justify-center gap-2">
                                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ©
                                </button>
                                <button onclick="openQtyModal('${id}', '${item.name}', 'sub', '${item.qty}')" class="bg-amber-500/10 hover:bg-amber-500 text-amber-500 hover:text-white py-3 rounded-xl transition font-bold flex items-center justify-center gap-2">
                                    <i class="fas fa-minus-circle"></i> Ø®ØµÙ…
                                </button>
                            </div>
                            <div class="mt-4 flex justify-between items-center opacity-40 group-hover:opacity-100 transition">
                                <button onclick="deleteItem('${id}')" class="text-[15px] text-red-400 hover:underline">
                                    <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„
                                </button>
                                <span class="text-[15px] text-slate-500 italic">ØªØ­Ø¯ÙŠØ«: ${new Date(item.updatedAt).toLocaleDateString('ar-EG')}</span>
                            </div>
                        </div>`;
                    grid.appendChild(card);
                });

                document.getElementById('statTotalItems').innerText = tItems;
                document.getElementById('statLowStock').innerText = lowStock;
                document.getElementById('statOrigin').innerText = `${hindi} Ù‡Ù†Ø¯ÙŠ / ${irani} Ø§ÙŠØ±Ø§Ù†ÙŠ `;
            });
        }

        // --- Modals UI ---
        window.openQtyModal = (id, name, action, currentQty) => {
    currentModalTarget = id;
    currentModalAction = action;
    document.getElementById('modalTitle').innerText = action === 'add' ? 'Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ§Ø± Ù„Ù„Ù…Ø®Ø²Ù†' : 'Ø®ØµÙ… Ø§Ù…ØªØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†';
    document.getElementById('modalItemName').innerText = name;
    // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
    document.getElementById('modalCurrentQty').innerText = `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: ${currentQty} Ù…ØªØ±`;
    
    document.getElementById('modalInput').value = '';
    document.getElementById('qtyModal').classList.add('active');
    setTimeout(() => document.getElementById('modalInput').focus(), 200);
};

        window.closeModal = () => {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        };

        window.openSettings = () => {
            document.getElementById('settingsModal').classList.add('active');
        };

        document.getElementById('btnConfirmQty').onclick = async () => {
            const val = parseFloat(document.getElementById('modalInput').value);
            if (!val || val <= 0) return;
            const finalVal = currentModalAction === 'add' ? val : -val;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', currentModalTarget);
                const docSnap = await getDoc(docRef);
                const currentData = docSnap.data();
                const newQty = currentData.qty + finalVal;
                if (newQty < 0) { alert("âš ï¸ Ø§Ù„Ø§Ù…ØªØ§Ø± ØºÙŠØ± ÙƒØ§ÙÙŠØ©!"); return; }
                await updateDoc(docRef, { 
                    qty: increment(finalVal),
                    updatedAt: new Date().toISOString()
                });
                if (currentModalAction === 'sub' && newQty <= 50) {
                    sendTelegramAlert(currentData.name, newQty, currentData.code);
                }
                closeModal();
            } catch (err) { console.error(err); }
        };

        window.deleteItem = async (id) => {
            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id));
            }
        };

        window.filterItems = (type) => {
            const cards = document.querySelectorAll('#productsGrid > div');
            cards.forEach(card => {
                if (type === 'Ø§Ù„ÙƒÙ„') card.style.display = 'block';
                else if (type === 'low') card.style.display = card.classList.contains('low-stock-pulse') ? 'block' : 'none';
            });
        };

        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('#productsGrid > div');
            cards.forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(term) ? 'block' : 'none';
            });
        };
    window.exportToExcel = async () => {
    try {
        const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
        
        const today = new Date().toLocaleDateString('ar-EG');
        
        // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØµÙŠØºØ© HTML Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚
        let htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; width: 100%; direction: rtl; }
                th { background-color: #1e293b; color: white; border: 1px solid #000; padding: 10px; }
                td { border: 1px solid #000; padding: 8px; text-align: center; }
                .low-stock { background-color: #ffcccc; color: #cc0000; font-weight: bold; }
                .header-info { background-color: #f1f5f9; font-weight: bold; text-align: right; }
            </style>
        </head>
        <body>
            <table>
                <tr>
                    <td colspan="10" class="header-info">ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: ${today}</td>
                </tr>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†</th>
                    <th>Ø§Ù„Ù…Ù†Ø´Ø£</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ù„Ø§Ù…ØªØ§Ø± Ø§Ù„Ù…ØªÙˆÙØ±Ø©</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù†ØªØ¬</th>
                </tr>
        `;

        querySnapshot.forEach(docSnap => {
            const item = docSnap.data();
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£
            let originSymbol = item.origin === 'Ø¥ÙŠØ±Ø§Ù†ÙŠ' ? 'Ø§ÙŠØ±Ø§Ù†ÙŠ' : 'Ù‡Ù†Ø¯ÙŠ';
            
            // ÙØ­Øµ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
            const qty = item.qty || 0;
            const rowStyle = qty <= 50 ? 'class="low-stock"' : '';
            
            // ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬
            const itemUpdateDate = item.updatedAt ? new Date(item.updatedAt).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

            htmlContent += `
                <tr>
                    <td>${item.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</td>
                    <td>${originSymbol}</td>
                    <td>${item.code || "N/A"}</td>
                    <td ${rowStyle}>${qty}</td>
                    <td>${itemUpdateDate}</td>
                </tr>
            `;
        });

        htmlContent += `
            </table>
        </body>
        </html>
        `;

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Blob Ø¨ØµÙŠØºØ© Excel
        const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const fileName = `ØªÙ‚Ø±ÙŠØ±_Ù…Ø®Ø²Ù†_Ø§Ù„Ø£Ø³Ø¯ÙŠ_${new Date().toISOString().split('T')[0]}.xls`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­");
    } catch (err) {
        console.error(err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±");
    }
};
window.exportToPDF = async () => {
    try {
        const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
        const today = new Date().toLocaleDateString('ar-EG');
        
        // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        let printContent = `
        <div dir="rtl" style="font-family: 'Cairo', sans-serif; padding: 20px;">
            <div style="text-align: center; border-bottom: 3px solid #38bdf8; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="margin: 0; color: #1e293b;">ğŸ“¦ Ù†Ø¸Ø§Ù… Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø£Ø³Ø¯ÙŠ Ù„Ù„Ø¨ÙˆØ±Ø³Ù„ÙŠÙ†</h1>
                <h2 style="margin: 10px 0; background: #f1f5f9; padding: 15px; border-radius: 10px; font-size: 22px;">ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: ${today}</h2>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background-color: #1e293b; color: white;">
                        <th style="border: 1px solid #000; padding: 12px;">Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬</th>
                        <th style="border: 1px solid #000; padding: 12px;">Ø§Ù„Ù…Ù†Ø´Ø£</th>
                        <th style="border: 1px solid #000; padding: 12px;">Ø§Ù„ÙƒÙˆØ¯</th>
                        <th style="border: 1px solid #000; padding: 12px;">Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Â²)</th>
                        <th style="border: 1px solid #000; padding: 12px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«</th>
                    </tr>
                </thead>
                <tbody>
        `;

        querySnapshot.forEach(docSnap => {
            const item = docSnap.data();
            let originSymbol = item.origin === 'Ø¥ÙŠØ±Ø§Ù†ÙŠ' ? 'Ø§ÙŠØ±Ø§Ù†ÙŠ' : 'Ù‡Ù†Ø¯ÙŠ';
            const qty = item.qty || 0;
            const isLow = qty <= 50;
            const itemUpdateDate = item.updatedAt ? new Date(item.updatedAt).toLocaleDateString('ar-EG') : '---';

            printContent += `
                <tr style="text-align: center; ${isLow ? 'background-color: #fee2e2;' : ''}">
                    <td style="border: 1px solid #000; padding: 10px; text-align: right;">${item.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</td>
                    <td style="border: 1px solid #000; padding: 10px;">${originSymbol}</td>
                    <td style="border: 1px solid #000; padding: 10px; font-weight: bold;">${item.code || "N/A"}</td>
                    <td style="border: 1px solid #000; padding: 10px; ${isLow ? 'color: #dc2626; font-weight: bold;' : ''}">${qty}</td>
                    <td style="border: 1px solid #000; padding: 10px; font-size: 20px;">${itemUpdateDate}</td>
                </tr>
            `;
        });

        printContent += `
                </tbody>
            </table>
            <div style="margin-top: 30px; text-align: left; font-size: 15px; color: #64748b;">
                Ø·ÙØ¨Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¯ÙŠ Ø§Ù„Ø°ÙƒÙŠ - ${new Date().toLocaleString('ar-EG')}
            </div>
        </div>
        `;

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        const printWindow = window.open('', '', 'width=900,height=700');
        printWindow.document.write(`
            <html>
                <head>
                    <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø®Ø²Ù† Ø§Ù„Ø£Ø³Ø¯ÙŠ - PDF</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; }
                        table { page-break-inside: auto; }
                        tr { page-break-inside: avoid; page-break-after: auto; }
                        @media print {
                            .no-print { display: none; }
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Ø¥Ø¹Ø·Ø§Ø¡ ÙˆÙ‚Øª Ø¨Ø³ÙŠØ· Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);

    } catch (err) {
        console.error(err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
    }
};
    </script>
</body>
</html>
